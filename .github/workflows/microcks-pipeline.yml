name: Zero QA Demo Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  microcks-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Start Docker
      - name: Start Microcks & Kafka
        run: |
          cd asyncapi
          sed -i 's/KEYCLOAK_ENABLED=true/KEYCLOAK_ENABLED=false/g' docker-compose-final.yml
          docker compose -f docker-compose-final.yml up -d
          echo "Waiting 60s for containers to initialize..."
          sleep 60
          docker ps

      # 2. Import Contract
      - name: Import API Contract
        run: |
          curl -X POST -F "file=@asyncapi/temperature-events-asyncapi.yaml" http://localhost:8080/api/artifact/upload

      # 3. Run Producer
      - name: Run Python Producer
        run: |
          pip install confluent-kafka
          python order-service/producer.py &
          echo "Producer running... waiting 10s for data flow"
          sleep 10

      # 4. Run Microcks Test (Native CLI Method - Failsafe)
      - name: Run Microcks Test
        run: |
          # Download the CLI binary directly to the host (Avoiding Docker networking/quoting issues)
          curl -fSL https://github.com/microcks/microcks-cli/releases/download/0.5.6/microcks-cli_0.5.6_linux_x86_64.tar.gz -o microcks-cli.tar.gz
          tar -zxf microcks-cli.tar.gz
          
          # Execute directly on the runner
          ./microcks-cli test "Temperature Events API:1.3.0" kafka:9092 ASYNC_API_SCHEMA \
            --microcksURL=http://localhost:8080/api \
            --waitFor=10sec \
            --keycloakClientId=microcks-serviceaccount \
            --keycloakClientSecret=dummy-secret
